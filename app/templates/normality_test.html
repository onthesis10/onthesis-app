{% extends 'layout.html' %}

{% block title %}Uji Normalitas{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 md:p-8" x-data="normalityTest()">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Uji Normalitas Data</h1>

        <!-- Kontainer Utama: Kontrol di Kiri, Hasil di Kanan -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Kolom Kiri: Input & Kontrol -->
            <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 h-fit">
                
                <!-- Pilihan Metode Input -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">1. Masukkan Data</h2>
                    <div class="flex rounded-lg shadow-sm">
                        <button @click="selectedTab = 'manual'" :class="{'bg-blue-600 text-white': selectedTab === 'manual', 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300': selectedTab !== 'manual'}" class="flex-1 px-4 py-2 rounded-l-lg focus:outline-none transition-colors duration-200">Manual</button>
                        <button @click="selectedTab = 'csv'" :class="{'bg-blue-600 text-white': selectedTab === 'csv', 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300': selectedTab !== 'csv'}" class="flex-1 px-4 py-2 focus:outline-none transition-colors duration-200">CSV</button>
                        <button @click="selectedTab = 'excel'" :class="{'bg-blue-600 text-white': selectedTab === 'excel', 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300': selectedTab !== 'excel'}" class="flex-1 px-4 py-2 rounded-r-lg focus:outline-none transition-colors duration-200">Excel</button>
                    </div>
                </div>

                <!-- Area Input Sesuai Pilihan -->
                <div class="mb-6">
                    <div x-show="selectedTab === 'manual'">
                        <textarea x-model="manualData" rows="8" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 focus:ring-2 focus:ring-blue-500" placeholder="Masukkan data numerik di sini, satu nilai per baris. Contoh:&#10;85&#10;92&#10;78&#10;..."></textarea>
                    </div>
                    <div x-show="selectedTab !== 'manual'">
                        <input type="file" @change="handleFileUpload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600"/>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Pastikan file Anda memiliki header kolom.</p>
                    </div>
                </div>

                <!-- Pilihan Variabel -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">2. Pilih Variabel</h2>
                    <select x-model="selectedVariable" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 focus:ring-2 focus:ring-blue-500" :disabled="variables.length === 0">
                        <option value="">-- Pilih Variabel --</option>
                        <template x-for="variable in variables" :key="variable">
                            <option :value="variable" x-text="variable"></option>
                        </template>
                    </select>
                </div>

                <!-- Pilihan Visualisasi -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">3. Pilih Visualisasi</h2>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="visualizations.histogram" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-gray-700 dark:text-gray-300">Histogram & Kurva Normal</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="visualizations.qq" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-gray-700 dark:text-gray-300">Q-Q Plot</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="visualizations.box" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-gray-700 dark:text-gray-300">Box Plot</span>
                        </label>
                    </div>
                </div>

                <!-- Tombol Aksi -->
                <div class="mt-8">
                    <button @click="runTest" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center" :disabled="!selectedVariable">
                        <svg x-show="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="loading ? 'Memproses...' : 'Jalankan Uji Normalitas'"></span>
                    </button>
                </div>
            </div>

            <!-- Kolom Kanan: Hasil -->
            <div class="lg:col-span-2">
                <div x-show="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline" x-text="error"></span>
                </div>

                <div x-show="results" class="space-y-8" x-cloak>
                     <!-- Header Hasil dan Tombol Ekspor -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Hasil Analisis</h2>
                        <button @click="exportToDoc" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 ease-in-out flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Ekspor ke DOC
                        </button>
                    </div>

                    <!-- Hasil Statistik -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Tabel Uji Normalitas</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Uji Statistik</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statistik</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">P-value</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Interpretasi (α = 0.05)</th>
                                    </tr>
                                </thead>
                                <tbody x-ref="resultsTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Hasil akan dimasukkan di sini oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Interpretasi Profesional -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Interpretasi Hasil</h3>
                        <div x-ref="interpretation" class="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
                           <!-- Interpretasi akan dimasukkan di sini -->
                        </div>
                    </div>
                    
                    <!-- Visualisasi Data -->
                    <div x-show="visualizations.histogram" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Histogram dan Kurva Normal</h3>
                        <canvas id="histogramChart"></canvas>
                    </div>

                    <div x-show="visualizations.qq" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Q-Q Plot (Quantile-Quantile)</h3>
                        <canvas id="qqPlotChart"></canvas>
                    </div>

                    <div x-show="visualizations.box" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Box Plot</h3>
                        <canvas id="boxPlotChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Elemen tersembunyi untuk ekspor -->
    <div id="exportContent" class="hidden"></div>
</div>

<!-- Library untuk parsing file dan kalkulasi statistik -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>

<!-- Library untuk visualisasi data (Chart.js) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.2.0/build/index.umd.min.js"></script>

<!-- Library untuk ekspor ke DOC -->
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('normalityTest', () => ({
        selectedTab: 'manual',
        manualData: '',
        fileData: null,
        variables: [],
        selectedVariable: '',
        results: null,
        error: '',
        loading: false,
        visualizations: {
            histogram: true,
            qq: true,
            box: true,
        },
        chartInstances: {},

        handleFileUpload(event) {
            this.loading = true;
            this.error = '';
            this.variables = [];
            this.selectedVariable = '';
            const file = event.target.files[0];
            if (!file) {
                this.loading = false;
                return;
            }

            if (this.selectedTab === 'csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        this.fileData = results.data;
                        this.variables = results.meta.fields;
                        this.loading = false;
                    },
                    error: (err) => {
                        this.error = `Gagal memproses file CSV: ${err.message}`;
                        this.loading = false;
                    }
                });
            } else if (this.selectedTab === 'excel') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        this.fileData = XLSX.utils.sheet_to_json(worksheet);
                        if (this.fileData.length > 0) {
                            this.variables = Object.keys(this.fileData[0]);
                        }
                        this.loading = false;
                    } catch (err) {
                        this.error = `Gagal memproses file Excel: ${err.message}`;
                        this.loading = false;
                    }
                };
                reader.onerror = () => {
                    this.error = 'Gagal membaca file.';
                    this.loading = false;
                };
                reader.readAsArrayBuffer(file);
            }
        },

        getData() {
            this.error = '';
            if (this.selectedTab === 'manual') {
                if (!this.manualData.trim()) return null;
                const data = this.manualData.trim().split('\n').map(Number).filter(n => !isNaN(n));
                if (data.length === 0) {
                    this.error = 'Data manual tidak valid atau kosong.';
                    return null;
                }
                this.variables = ['value'];
                this.selectedVariable = 'value';
                return data.map(val => ({ value: val }));
            }
            return this.fileData;
        },

        runTest() {
            this.loading = true;
            this.results = null;
            this.error = '';
            
            Object.values(this.chartInstances).forEach(chart => chart.destroy());
            this.chartInstances = {};

            setTimeout(() => {
                const allData = this.getData();
                if (!allData || !this.selectedVariable) {
                    this.error = this.error || 'Silakan pilih variabel untuk diuji.';
                    this.loading = false;
                    return;
                }

                const data = allData.map(row => parseFloat(row[this.selectedVariable])).filter(n => !isNaN(n));

                if (data.length < 3) {
                    this.error = 'Data tidak cukup untuk uji normalitas (diperlukan minimal 3 data poin).';
                    this.loading = false;
                    return;
                }

                try {
                    const shapiro = this.shapiroWilk(data);
                    const ks = this.kolmogorovSmirnov(data);

                    this.results = { shapiro, ks, data };
                    this.displayResults(this.results);
                    
                    if (this.visualizations.histogram) this.renderHistogram(data);
                    if (this.visualizations.qq) this.renderQQPlot(data);
                    if (this.visualizations.box) this.renderBoxPlot(data);

                } catch (e) {
                    this.error = `Terjadi kesalahan saat analisis: ${e.message}`;
                } finally {
                    this.loading = false;
                }
            }, 50);
        },

        displayResults(results) {
            // Display table
            const tableBody = this.$refs.resultsTable;
            tableBody.innerHTML = '';
            const createRow = (testName, statistic, pValue) => {
                const isNormal = pValue > 0.05;
                return `
                    <tr class="text-gray-700 dark:text-gray-300">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${testName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statistic.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${pValue.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isNormal ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                ${isNormal ? 'Distribusi Normal' : 'Distribusi Tidak Normal'}
                            </span>
                        </td>
                    </tr>
                `;
            };
            tableBody.innerHTML += createRow('Shapiro-Wilk', results.shapiro.W, results.shapiro.p);
            tableBody.innerHTML += createRow('Kolmogorov-Smirnov', results.ks.D, results.ks.p);

            // Display professional interpretation
            const interpretationDiv = this.$refs.interpretation;
            const mean = jstat.mean(results.data);
            const stdev = jstat.stdev(results.data, true);
            const n = results.data.length;
            const shapiroNormal = results.shapiro.p > 0.05;
            const ksNormal = results.ks.p > 0.05;

            interpretationDiv.innerHTML = `
                <h4>1. Ringkasan Statistik Deskriptif</h4>
                <p>Analisis dilakukan terhadap variabel <strong>${this.selectedVariable}</strong> dengan jumlah sampel (n) sebanyak <strong>${n}</strong>. Data memiliki rata-rata (mean) sebesar <strong>${mean.toFixed(2)}</strong> dan standar deviasi sebesar <strong>${stdev.toFixed(2)}</strong>.</p>
                
                <h4>2. Hasil Uji Hipotesis</h4>
                <p>Dua uji statistik digunakan untuk menguji hipotesis nol (H₀) bahwa data berdistribusi normal.</p>
                <ul>
                    <li><strong>Uji Shapiro-Wilk:</strong> Menghasilkan nilai p-value sebesar <strong>${results.shapiro.p.toFixed(4)}</strong>. Karena nilai ini ${shapiroNormal ? 'lebih besar dari' : 'lebih kecil dari atau sama dengan'} tingkat signifikansi α = 0.05, maka ${shapiroNormal ? 'gagal menolak H₀, yang mengindikasikan bahwa data berdistribusi normal.' : 'H₀ ditolak, yang menunjukkan bahwa data tidak berdistribusi normal.'}</li>
                    <li><strong>Uji Kolmogorov-Smirnov:</strong> Menghasilkan nilai p-value sebesar <strong>${results.ks.p.toFixed(4)}</strong>. Karena nilai ini ${ksNormal ? 'lebih besar dari' : 'lebih kecil dari atau sama dengan'} tingkat signifikansi α = 0.05, maka ${ksNormal ? 'gagal menolak H₀, yang mengindikasikan bahwa data berdistribusi normal.' : 'H₀ ditolak, yang menunjukkan bahwa data tidak berdistribusi normal.'}</li>
                </ul>

                <h4>3. Analisis Visual</h4>
                <p>Evaluasi visual dari plot memberikan wawasan tambahan:</p>
                <ul>
                    ${this.visualizations.histogram ? '<li><strong>Histogram:</strong> Bentuk distribusi frekuensi data secara visual dibandingkan dengan kurva normal ideal.</li>' : ''}
                    ${this.visualizations.qq ? '<li><strong>Q-Q Plot:</strong> Titik-titik data diobservasi; jika mendekati garis diagonal lurus, ini mendukung asumsi normalitas.</li>' : ''}
                    ${this.visualizations.box ? '<li><strong>Box Plot:</strong> Digunakan untuk mengidentifikasi kesimetrisan distribusi dan keberadaan pencilan (outliers).</li>' : ''}
                </ul>

                <h4>4. Kesimpulan</h4>
                <p>Berdasarkan kombinasi hasil uji statistik dan analisis visual, dapat disimpulkan bahwa asumsi normalitas untuk variabel <strong>${this.selectedVariable}</strong> ${shapiroNormal && ksNormal ? '<strong>terpenuhi</strong>' : '<strong>tidak terpenuhi</strong>'}.</p>
            `;
        },
        
        kolmogorovSmirnov(data) {
            const n = data.length;
            if (n === 0) return { D: NaN, p: NaN };
            const sortedData = [...data].sort((a, b) => a - b);
            const mean = jstat.mean(sortedData);
            const stdev = jstat.stdev(sortedData, true);
            
            let dMax = 0;
            for (let i = 0; i < n; i++) {
                const cdf = jstat.normal.cdf(sortedData[i], mean, stdev);
                const d1 = (i + 1) / n - cdf;
                const d2 = cdf - i / n;
                dMax = Math.max(dMax, d1, d2);
            }
            
            // Lilliefors corrected p-value approximation
            const K = Math.sqrt(n) * dMax;
            let pValue;
            if (K <= 0.5) pValue = 1;
            else if (K > 1.0) pValue = Math.exp(-2.000071 * K * K - 0.331 * Math.pow(K, 4) + 0.06 * Math.pow(K, 6));
            else pValue = 1 - (1/K) * Math.exp(-Math.PI * Math.PI / (8*K*K));
            
            return { D: dMax, p: Math.min(1, Math.max(0, pValue)) };
        },

        shapiroWilk(data) {
            const n = data.length;
            if (n < 3 || n > 5000) {
                 console.warn("Shapiro-Wilk test requires sample size between 3 and 5000.");
                 return { W: NaN, p: NaN };
            }
            try {
                return jstat.shapiroWilk(data);
            } catch (e) {
                console.error("Error in Shapiro-Wilk calculation:", e);
                return { W: NaN, p: NaN };
            }
        },

        renderHistogram(data) {
            const ctx = document.getElementById('histogramChart').getContext('2d');
            const n = data.length;
            const mean = jstat.mean(data);
            const stdev = jstat.stdev(data, true);
            const numBins = Math.ceil(1 + Math.log2(n));
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binWidth = (max - min) / numBins;
            const bins = Array(numBins).fill(0);
            const labels = [];
            for (let i = 0; i < numBins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = binStart + binWidth;
                labels.push(`${binStart.toFixed(2)}-${binEnd.toFixed(2)}`);
            }
            data.forEach(value => {
                let binIndex = Math.floor((value - min) / binWidth);
                if (binIndex === numBins) binIndex--;
                bins[binIndex]++;
            });
            const normalCurveData = labels.map((_, i) => {
                const x = min + (i + 0.5) * binWidth;
                const pdfValue = jstat.normal.pdf(x, mean, stdev);
                return pdfValue * n * binWidth; 
            });
            this.chartInstances.histogram = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Frekuensi', data: bins, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }, { label: 'Kurva Normal Ideal', data: normalCurveData, type: 'line', borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: false, tension: 0.4, pointRadius: 0 }] },
                options: { responsive: true, animation: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Frekuensi' } }, x: { title: { display: true, text: 'Nilai' } } } }
            });
        },

        renderQQPlot(data) {
            const ctx = document.getElementById('qqPlotChart').getContext('2d');
            const sortedData = [...data].sort((a, b) => a - b);
            const n = sortedData.length;
            const quantiles = sortedData.map((_, i) => (i + 0.5) / n);
            const theoreticalQuantiles = quantiles.map(q => jstat.normal.inv(q, 0, 1));
            const plotData = sortedData.map((sampleQuantile, i) => ({ x: theoreticalQuantiles[i], y: sampleQuantile }));
            const mean = jstat.mean(data);
            const stdev = jstat.stdev(data, true);
            this.chartInstances.qq = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: [{ label: 'Data Quantiles', data: plotData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { type: 'line', label: 'Garis Normal Ideal', data: [{x: -3, y: mean - 3*stdev}, {x: 3, y: mean + 3*stdev}], borderColor: 'rgba(255, 99, 132, 1)', fill: false, pointRadius: 0, borderDash: [5, 5] }] },
                options: { responsive: true, animation: false, scales: { x: { title: { display: true, text: 'Theoretical Quantiles (Z-score)' } }, y: { title: { display: true, text: 'Sample Quantiles' } } } }
            });
        },

        renderBoxPlot(data) {
            const ctx = document.getElementById('boxPlotChart').getContext('2d');
            this.chartInstances.box = new Chart(ctx, {
                type: 'boxplot',
                data: { labels: [this.selectedVariable || 'Data'], datasets: [{ label: 'Distribusi Data', data: [data], backgroundColor: 'rgba(255, 159, 64, 0.6)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1, itemRadius: 2 }] },
                options: { responsive: true, animation: false, plugins: { legend: { display: false } }, scales: { y: { title: { display: true, text: 'Nilai' } } } }
            });
        },

        exportToDoc() {
            const exportContainer = document.getElementById('exportContent');
            
            let content = `<h1>Laporan Hasil Uji Normalitas</h1>`;
            content += `<h2>Variabel: ${this.selectedVariable}</h2>`;
            
            // Tabel Hasil
            content += `<h3>Tabel Uji Normalitas</h3>`;
            content += document.querySelector('table').outerHTML;

            // Interpretasi
            content += `<h3>Interpretasi Hasil</h3>`;
            content += this.$refs.interpretation.innerHTML;

            // Gambar Grafik
            content += `<h3>Visualisasi Data</h3>`;
            if (this.visualizations.histogram && this.chartInstances.histogram) {
                content += `<h4>Histogram dan Kurva Normal</h4><img src="${this.chartInstances.histogram.toBase64Image()}" style="max-width:500px;" />`;
            }
            if (this.visualizations.qq && this.chartInstances.qq) {
                content += `<h4>Q-Q Plot</h4><img src="${this.chartInstances.qq.toBase64Image()}" style="max-width:500px;" />`;
            }
            if (this.visualizations.box && this.chartInstances.box) {
                content += `<h4>Box Plot</h4><img src="${this.chartInstances.box.toBase64Image()}" style="max-width:500px;" />`;
            }

            exportContainer.innerHTML = content;

            var converted = htmlDocx.asBlob(exportContainer.innerHTML);
            saveAs(converted, 'Laporan_Uji_Normalitas.docx');
            exportContainer.innerHTML = ''; // Kosongkan kembali
        }
    }))
})
</script>
{% endblock %}
